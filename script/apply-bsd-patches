#!/bin/sh

# this script should run after electron's patch system
# because python-patch is stupid...

set -e

SCRIPT_DIR=$(readlink -f $(dirname $0))
ROOT_DIR=$(dirname $SCRIPT_DIR)
SRC_DIR=$ROOT_DIR/src
PATCH_DIR=$ROOT_DIR/tmp/bsd-patch

FREEBSD_CHROMIUM_REPO=https://github.com/gliaskos/freebsd-chromium

CHROMIUM_VERSION=$(cat "$ROOT_DIR/VERSION")
FREEBSD_PATCHES_VERSION=$(cat "$ROOT_DIR/bsd-commits.list" |
                         sed 's/ *= */=/' |
                         grep -F "$CHROMIUM_VERSION=" |
                         sed 's/.*=//' | head -1 )

if [ ! -d "$SRC_DIR" ]; then
    echo "src dir not exists"
    echo "please run script/update first"
    exit 1
fi

# if src dir is newer than patch dir, clear it
if [ "$SRC_DIR" -nt "$PATCH_DIR" ]; then
    rm -rf "$PATCH_DIR"
fi

# if patch version changed, clear it
if [ -f "$PATCH_DIR/version" ]; then
    if [ "$(cat "$PATCH_DIR/version")" != "$FREEBSD_PATCHES_VERSION" ]; then
        rm -rf "$PATCH_DIR"
    fi
fi

mkdir -p "$PATCH_DIR"
cd $PATCH_DIR

echo "$FREEBSD_PATCHES_VERSION" > version

# get freebsd-chromium
if [ ! -f "patch.zip" ]; then
    PATCHES_URL=$FREEBSD_CHROMIUM_REPO/archive/$FREEBSD_PATCHES_VERSION.zip
    fetch $PATCHES_URL -o patch.zip
fi

# unpack
if [ ! -d "freebsd-chromium" ]; then
    unzip patch.zip
    mv freebsd-chromium-* freebsd-chromium
fi

# make a fake ports environment, to reuse freebsd-chromium patch logic
# it's really too complex, rewrite it is not a good idea.
cd freebsd-chromium/www/chromium
mkdir -p work
ln -s "$SRC_DIR" "work/chromium-$CHROMIUM_VERSION"
touch work/.extract_done.chromium._usr_local

# see patches/launch_posix.cc.patch
rm -rf files/patch-base_process_launch__posix.cc


# if already patched, do nothing
if [ -f 'work/.patch_done.chromium._usr_local' ]; then
    echo "already applied bsd patches, exit"
    echo "if you want to patch again, just remove work/.patch_done.chromium._usr_local"
    exit 0
fi


# pre-patch
# backup *.orig generated by electron, to avoid conflict
find "$SRC_DIR" -name "*.orig" | while read line; do
    mv "$line" "${line%.orig}.orig-electron"
done
# rollback all *.orig-bsd
find "$SRC_DIR" -name "*.orig-bsd" | while read line; do
    echo "rollback $line"
    mv "$line" "${line%.orig-bsd}"
done


# patch it
make patch BATCH=1


# post-patch
# rename all bsd generated *.orig to *.orig-bsd
find "$SRC_DIR" -name "*.orig" | while read line; do
    mv "$line" "${line%.orig}.orig-bsd"
done
# move *.orig-electron back to *.orig
find "$SRC_DIR" -name "*.orig-electron" | while read line; do
    mv "$line" "${line%.orig-electron}"
done


# also make gn tool
#make configure
#cp "work/chromium-$CHROMIUM_VERSION/out/Release/gn" $PATCH_DIR
